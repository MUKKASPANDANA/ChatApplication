<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChatterBox - Modern Chat App</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            overflow: hidden;
        }

        /* Auth Screen Styles */
        .auth-screen {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 1rem;
        }

        .auth-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 2.5rem;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 400px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .auth-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .auth-title {
            font-size: 2rem;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 0.5rem;
        }

        .auth-subtitle {
            color: #718096;
            font-size: 0.9rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            color: #4a5568;
            font-weight: 500;
            font-size: 0.9rem;
        }

        .form-input {
            width: 100%;
            padding: 0.875rem 1rem;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.2s;
            background: white;
        }

        .form-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .auth-btn {
            width: 100%;
            padding: 1rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 1rem;
        }

        .auth-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .auth-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .auth-switch {
            text-align: center;
            margin-top: 1.5rem;
            color: #718096;
            font-size: 0.9rem;
        }

        .auth-switch-btn {
            color: #667eea;
            background: none;
            border: none;
            cursor: pointer;
            font-weight: 600;
            text-decoration: underline;
        }

        /* Chat Screen Styles */
        .chat-screen {
            display: none;
            height: 100vh;
            background: #f7fafc;
            position: relative;
        }

        .chat-container {
            display: flex;
            height: 100%;
            position: relative;
        }

        /* Mobile Header */
        .mobile-header {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            z-index: 1001;
            padding: 0 1rem;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 10px rgba(102, 126, 234, 0.3);
        }

        .mobile-menu-toggle {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 0.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.2s;
        }

        .mobile-menu-toggle:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .mobile-room-title {
            font-size: 1.1rem;
            font-weight: 600;
            text-align: center;
            flex: 1;
            margin: 0 1rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .mobile-user-menu {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 0.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
        }

        /* Sidebar */
        .sidebar {
            width: 320px;
            background: white;
            border-right: 1px solid #e2e8f0;
            display: flex;
            flex-direction: column;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
            position: relative;
            z-index: 999;
            padding-bottom: 1.5rem;
        }

        .sidebar-header {
            padding: 1.5rem;
            border-bottom: 1px solid #e2e8f0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 1.2rem;
        }

        .user-details h3 {
            font-size: 1.1rem;
            margin-bottom: 0.25rem;
        }

        .user-status {
            font-size: 0.8rem;
            opacity: 0.8;
        }

        .logout-btn {
            margin-left: auto;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 0.5rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* Room Creation */
        .room-creation {
            padding: 1rem;
            border-bottom: 1px solid #e2e8f0;
        }

        .room-input-group {
            display: flex;
            gap: 0.5rem;
        }

        .room-input {
            flex: 1;
            padding: 0.75rem;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 0.9rem;
        }

        .create-room-btn {
            padding: 0.75rem 1rem;
            background: #48bb78;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
            min-width: 44px;
        }

        .create-room-btn:hover {
            background: #38a169;
        }

        /* Rooms List */
        .rooms-section {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }

        .rooms-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: #4a5568;
            margin-bottom: 1rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .room-item {
            padding: 1rem;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            min-height: 60px;
        }

        .room-item:hover {
            background: #f7fafc;
            transform: translateX(4px);
        }

        .room-item.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            transform: translateX(4px);
        }

        .room-emoji {
            font-size: 1.5rem;
            flex-shrink: 0;
        }

        .room-info {
            flex: 1;
            min-width: 0;
        }

        .room-info h4 {
            font-size: 1rem;
            margin-bottom: 0.25rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .room-meta {
            font-size: 0.8rem;
            opacity: 0.7;
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .online-count {
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .online-dot {
            width: 6px;
            height: 6px;
            background: #48bb78;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Main Chat Area */
        .chat-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: white;
            min-width: 0;
        }

        .chat-header {
            padding: 1.5rem;
            border-bottom: 1px solid #e2e8f0;
            background: white;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .chat-header h2 {
            font-size: 1.5rem;
            color: #2d3748;
            margin-bottom: 0.25rem;
        }

        .chat-subtitle {
            color: #718096;
            font-size: 0.9rem;
        }

        /* Messages Container */
        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
            background: linear-gradient(180deg, #f9fafb 0%, #ffffff 100%);
            scroll-behavior: smooth;
        }

        .message {
            margin-bottom: 1.5rem;
            display: flex;
            gap: 1rem;
            animation: messageSlide 0.3s ease-out;
        }

        @keyframes messageSlide {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.own {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 0.9rem;
            flex-shrink: 0;
        }

        .message.own .message-avatar {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
        }

        .message-content {
            max-width: 70%;
            min-width: 0;
            flex: 1;
        }

        .message-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.5rem;
        }

        .message.own .message-header {
            flex-direction: row-reverse;
        }

        .message-author {
            font-weight: 600;
            color: #2d3748;
            font-size: 0.9rem;
        }

        .message-time {
            font-size: 0.8rem;
            color: #a0aec0;
        }

        .message-text {
            background: white;
            padding: 1rem 1.25rem;
            border-radius: 18px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            color: #2d3748;
            line-height: 1.5;
            border: 1px solid #f1f5f9;
            word-wrap: break-word;
            overflow-wrap: break-word;
            max-width: 100%;
        }

        .message-text a {
            color: #667eea;
            text-decoration: underline;
        }

        .message-text strong {
            font-weight: 700;
        }

        .message-text em {
            font-style: italic;
        }

        .message.own .message-text {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
        }

        .message.own .message-text a {
            color: #e2e8f0;
        }

        /* Typing indicator */
        .typing-indicator {
            padding: 1rem 1.5rem;
            font-style: italic;
            color: #718096;
            font-size: 0.9rem;
            border-top: 1px solid #e2e8f0;
            background: #f7fafc;
        }

        .typing-dots {
            display: inline-block;
            animation: blink 1.4s infinite;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }

        /* Message Input */
        .message-input-container {
            padding: 1.5rem;
            border-top: 1px solid #e2e8f0;
            background: white;
        }

        .formatting-toolbar {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            justify-content: flex-start;
        }

        .format-btn {
            padding: 0.5rem 0.75rem;
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
            min-width: 44px;
            text-align: center;
        }

        .format-btn:hover {
            background: #edf2f7;
            border-color: #cbd5e0;
        }

        .format-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .message-input-group {
            display: flex;
            gap: 1rem;
            align-items: flex-end;
        }

        .message-input {
            flex: 1;
            padding: 1rem 1.25rem;
            border: 2px solid #e2e8f0;
            border-radius: 20px;
            font-size: 1rem;
            resize: none;
            max-height: 120px;
            min-height: 50px;
            font-family: inherit;
            transition: all 0.2s;
        }

        .message-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .send-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .send-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
        }

        /* Utility Classes */
        .hidden {
            display: none !important;
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            color: #667eea;
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #e2e8f0;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .message-alert {
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 10px;
            font-size: 0.9rem;
            text-align: center;
        }

        .message-success {
            background: #f0fff4;
            color: #38a169;
            border: 1px solid #c6f6d5;
        }

        .message-error {
            background: #fed7d7;
            color: #e53e3e;
            border: 1px solid #feb2b2;
        }

        /* Sidebar overlay for mobile */
        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 998;
            backdrop-filter: blur(2px);
        }

        /* Message formatting preview */
        .format-preview {
            font-size: 0.8rem;
            color: #718096;
            margin-top: 0.5rem;
            padding: 0.5rem;
            background: #f7fafc;
            border-radius: 8px;
            min-height: 1.5rem;
        }

        /* Responsive Styles */
        @media (max-width: 768px) {
            .auth-container {
                margin: 1rem;
                padding: 1.5rem;
                border-radius: 16px;
            }

            .auth-title {
                font-size: 1.75rem;
            }

            .mobile-header {
                display: flex;
            }

            .sidebar {
                position: fixed;
                top: 0;
                left: 0;
                height: 100vh;
                z-index: 999;
                transform: translateX(-100%);
                width: 85vw;
                max-width: 320px;
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .sidebar-overlay.active {
                display: block;
            }

            .chat-main {
                width: 100%;
                padding-top: 60px;
            }

            .chat-header {
                display: none;
            }

            .messages-container {
                padding: 1rem;
                padding-bottom: 1rem;
            }

            .message-input-container {
                padding: 1rem;
                padding-bottom: calc(1rem + env(safe-area-inset-bottom));
            }

            .message-content {
                max-width: 75%;
            }

            .formatting-toolbar {
                gap: 0.25rem;
                justify-content: space-between;
            }

            .format-btn {
                flex: 1;
                max-width: 60px;
                padding: 0.4rem 0.3rem;
                font-size: 0.8rem;
            }

            .room-creation {
                padding: 0.75rem;
            }

            .rooms-section {
                padding: 0.75rem;
            }

            .sidebar-header {
                padding: 1rem;
            }

            .message-input-group {
                gap: 0.75rem;
            }

            .message {
                gap: 0.75rem;
            }

            .message-text {
                padding: 0.875rem 1rem;
            }
        }

        @media (max-width: 480px) {
            .auth-container {
                padding: 1.25rem;
                margin: 0.5rem;
            }

            .sidebar {
                width: 90vw;
            }

            .mobile-header {
                padding: 0 0.75rem;
            }

            .mobile-room-title {
                font-size: 1rem;
            }

            .message-input-group {
                gap: 0.5rem;
            }

            .send-btn {
                width: 45px;
                height: 45px;
                font-size: 1.1rem;
            }

            .message {
                gap: 0.5rem;
                margin-bottom: 1rem;
            }

            .message-avatar {
                width: 32px;
                height: 32px;
                font-size: 0.8rem;
            }

            .message-content {
                max-width: 80%;
            }

            .message-text {
                padding: 0.75rem 1rem;
                font-size: 0.9rem;
            }

            .messages-container {
                padding: 0.75rem;
            }

            .message-input-container {
                padding: 0.75rem;
                padding-bottom: calc(0.75rem + env(safe-area-inset-bottom));
            }

            .formatting-toolbar {
                margin-bottom: 0.75rem;
            }

            .format-btn {
                font-size: 0.75rem;
                padding: 0.35rem 0.25rem;
            }

            .room-item {
                padding: 0.75rem;
                gap: 0.75rem;
            }

            .room-emoji {
                font-size: 1.25rem;
            }

            .room-info h4 {
                font-size: 0.9rem;
            }

            .room-meta {
                font-size: 0.75rem;
                gap: 0.5rem;
            }
        }

        @media (max-width: 360px) {
            .message-content {
                max-width: 85%;
            }
            
            .format-btn {
                min-width: 40px;
                font-size: 0.7rem;
            }

            .mobile-room-title {
                font-size: 0.9rem;
            }
        }

        /* Landscape phone orientation */
        @media (max-height: 500px) and (orientation: landscape) {
            .messages-container {
                padding: 0.75rem;
            }

            .message-input-container {
                padding: 0.75rem;
            }

            .formatting-toolbar {
                margin-bottom: 0.5rem;
            }

            .sidebar-header {
                padding: 0.75rem;
            }

            .room-creation {
                padding: 0.5rem;
            }

            .rooms-section {
                padding: 0.5rem;
            }
        }

        /* High DPI displays */
        @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
            .message-text {
                border-width: 0.5px;
            }

            .form-input {
                border-width: 1px;
            }
        }

        /* Tablet styles */
        @media (min-width: 769px) and (max-width: 1024px) {
            .sidebar {
                width: 280px;
            }

            .messages-container {
                padding: 1.25rem;
            }

            .message-content {
                max-width: 65%;
            }
        }

        /* Large screens */
        @media (min-width: 1200px) {
            .sidebar {
                width: 350px;
            }

            .message-content {
                max-width: 60%;
            }
        }

        /* Reduced motion preferences */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* Dark mode support */
        @media (prefers-color-scheme: dark) {
            .auth-container {
                background: rgba(45, 55, 72, 0.95);
                border: 1px solid rgba(255, 255, 255, 0.1);
            }

            .auth-title {
                color: #f7fafc;
            }

            .form-input {
                background: rgba(255, 255, 255, 0.05);
                border-color: rgba(255, 255, 255, 0.1);
                color: #f7fafc;
            }

            .message-text {
                background: rgba(45, 55, 72, 0.8);
                color: #f7fafc;
                border: 1px solid rgba(255, 255, 255, 0.1);
            }
        }
    </style>
</head>
<body>
    <!-- Auth Screen -->
    <div id="authScreen" class="auth-screen">
        <div class="auth-container">
            <div class="auth-header">
                <h1 id="authTitle" class="auth-title">Welcome Back</h1>
                <p class="auth-subtitle">Sign in to continue chatting</p>
            </div>

            <form id="authForm">
                <div class="form-group">
                    <label class="form-label" for="email">Email Address</label>
                    <input type="email" id="email" class="form-input" required>
                </div>

                <div class="form-group">
                    <label class="form-label" for="password">Password</label>
                    <input type="password" id="password" class="form-input" required>
                </div>

                <div id="usernameGroup" class="form-group hidden">
                    <label class="form-label" for="username">Display Name</label>
                    <input type="text" id="username" class="form-input">
                </div>

                <div id="loading" class="loading hidden">
                    <div class="spinner"></div>
                    <span>Processing...</span>
                </div>

                <div id="errorMessage" class="message-alert message-error hidden"></div>
                <div id="successMessage" class="message-alert message-success hidden"></div>

                <button type="submit" id="authSubmit" class="auth-btn">Sign In</button>
            </form>

            <div class="auth-switch">
                <span id="authSwitchText">Don't have an account?</span>
                <button type="button" id="authSwitchBtn" class="auth-switch-btn">Sign Up</button>
            </div>
        </div>
    </div>

    <!-- Chat Screen -->
    <div id="chatScreen" class="chat-screen">
        <!-- Mobile Header -->
        <div class="mobile-header" id="mobileHeader">
            <button id="mobileMenuToggle" class="mobile-menu-toggle">☰</button>
            <div id="mobileRoomTitle" class="mobile-room-title">Select a room</div>
            <button id="mobileUserMenu" class="mobile-user-menu">➜]</button>
        </div>

        <div class="sidebar-overlay" id="sidebarOverlay"></div>
        
        <div class="chat-container">
            <!-- Sidebar -->
            <div class="sidebar" id="sidebar">
                <div class="sidebar-header">
                    <div class="user-info">
                        <div id="userAvatar" class="user-avatar"></div>
                        <div class="user-details">
                            <h3 id="currentUsername">User</h3>
                            <div class="user-status">Online</div>
                        </div>
                        <button id="logoutBtn" class="logout-btn">➜</button>
                    </div>
                </div>

                <div class="room-creation">
                    <div class="room-input-group">
                        <input type="text" id="newRoomInput" class="room-input" placeholder="Create new room...">
                        <button id="createRoomBtn" class="create-room-btn">+</button>
                    </div>
                </div>

                <div class="rooms-section">
                    <h3 class="rooms-title">Chat Rooms</h3>
                    <div id="roomsList"></div>
                </div>
            </div>

            <!-- Main Chat -->
            <div class="chat-main">
                <div class="chat-header">
                    <h2 id="currentRoomName">Select a room</h2>
                    <p id="currentRoomSubtitle" class="chat-subtitle">Choose a room to start chatting</p>
                </div>

                <div id="messagesContainer" class="messages-container">
                    <div style="text-align: center; padding: 3rem; color: #a0aec0;">
                        <h3>Welcome to ChatterBox! 💬</h3>
                        <p>Select a room from the sidebar to start chatting</p>
                    </div>
                </div>

                <div id="typingIndicator" class="typing-indicator hidden">
                    <span id="typingText">Someone is typing</span><span class="typing-dots">...</span>
                </div>

                <div class="message-input-container">
                    <div class="formatting-toolbar">
                        <button class="format-btn" data-format="bold" title="Bold">B</button>
                        <button class="format-btn" data-format="italic" title="Italic">I</button>
                        <button class="format-btn" data-format="code" title="Code">{ }</button>
                        <button class="format-btn" data-format="link" title="Link">🔗</button>
                    </div>
                    
                    <div class="message-input-group">
                        <textarea id="messageInput" class="message-input" placeholder="Type your message..." disabled></textarea>
                        <button id="sendBtn" class="send-btn" disabled>
                            <span>➤</span>
                        </button>
                    </div>
                    
                    <div id="formatPreview" class="format-preview">Start typing to see formatting preview...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { 
            getAuth, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            signOut, 
            onAuthStateChanged,
            updateProfile 
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { 
            getFirestore, 
            collection, 
            doc, 
            addDoc, 
            setDoc, 
            query, 
            orderBy, 
            onSnapshot, 
            serverTimestamp,
            where,
            limit,
            updateDoc,
            arrayUnion,
            arrayRemove,
            getDocs
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Firebase configuration
        const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
    projectId: "YOUR_PROJECT_ID",
    storageBucket: "YOUR_PROJECT_ID.appspot.com",
    messagingSenderId: "YOUR_SENDER_ID",
    appId: "YOUR_APP_ID",
    measurementId: "YOUR_MEASUREMENT_ID"
};


        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        class ChatterBoxApp {
            constructor() {
                this.currentUser = null;
                this.currentRoom = null;
                this.currentRoomName = '';
                this.isLogin = true;
                this.messagesUnsubscribe = null;
                this.roomsUnsubscribe = null;
                this.typingUsers = new Set();
                this.typingTimeout = null;
                this.isTyping = false;
                this.isMobile = window.innerWidth <= 768;
                
                this.initializeElements();
                this.attachEventListeners();
                this.initializeAuth();
                this.initializeFormatting();
                this.handleResize();
            }

            initializeElements() {
                // Auth elements
                this.authScreen = document.getElementById('authScreen');
                this.chatScreen = document.getElementById('chatScreen');
                this.authForm = document.getElementById('authForm');
                this.authTitle = document.getElementById('authTitle');
                this.authSubmit = document.getElementById('authSubmit');
                this.authSwitchText = document.getElementById('authSwitchText');
                this.authSwitchBtn = document.getElementById('authSwitchBtn');
                this.emailInput = document.getElementById('email');
                this.passwordInput = document.getElementById('password');
                this.usernameInput = document.getElementById('username');
                this.usernameGroup = document.getElementById('usernameGroup');
                this.loading = document.getElementById('loading');
                this.errorMessage = document.getElementById('errorMessage');
                this.successMessage = document.getElementById('successMessage');

                // Chat elements
                this.currentUsername = document.getElementById('currentUsername');
                this.userAvatar = document.getElementById('userAvatar');
                this.logoutBtn = document.getElementById('logoutBtn');
                this.roomsList = document.getElementById('roomsList');
                this.currentRoomNameElement = document.getElementById('currentRoomName');
                this.currentRoomSubtitle = document.getElementById('currentRoomSubtitle');
                this.messagesContainer = document.getElementById('messagesContainer');
                this.messageInput = document.getElementById('messageInput');
                this.sendBtn = document.getElementById('sendBtn');
                this.newRoomInput = document.getElementById('newRoomInput');
                this.createRoomBtn = document.getElementById('createRoomBtn');
                this.typingIndicator = document.getElementById('typingIndicator');
                this.typingText = document.getElementById('typingText');
                this.formatPreview = document.getElementById('formatPreview');

                // Mobile elements
                this.mobileHeader = document.getElementById('mobileHeader');
                this.mobileMenuToggle = document.getElementById('mobileMenuToggle');
                this.mobileRoomTitle = document.getElementById('mobileRoomTitle');
                this.mobileUserMenu = document.getElementById('mobileUserMenu');
                this.sidebar = document.getElementById('sidebar');
                this.sidebarOverlay = document.getElementById('sidebarOverlay');
            }

            attachEventListeners() {
                // Auth events
                this.authForm.addEventListener('submit', (e) => this.handleAuth(e));
                this.authSwitchBtn.addEventListener('click', () => this.toggleAuthMode());

                // Chat events
                this.logoutBtn.addEventListener('click', () => this.handleLogout());
                this.createRoomBtn.addEventListener('click', () => this.createRoom());
                this.newRoomInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.createRoom();
                });
                this.sendBtn.addEventListener('click', () => this.sendMessage());
                this.messageInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        this.sendMessage();
                    }
                });
                this.messageInput.addEventListener('input', () => {
                    this.updateFormatPreview();
                    this.handleTyping();
                    this.resizeTextarea();
                });

                // Mobile events
                this.mobileMenuToggle.addEventListener('click', () => this.toggleMobileMenu());
                this.mobileUserMenu.addEventListener('click', () => this.showMobileUserMenu());
                this.sidebarOverlay.addEventListener('click', () => this.closeMobileMenu());

                // Resize handler
                window.addEventListener('resize', () => this.handleResize());

                // Keyboard shortcuts for formatting
                this.messageInput.addEventListener('keydown', (e) => {
                    if (e.ctrlKey || e.metaKey) {
                        switch (e.key) {
                            case 'b':
                                e.preventDefault();
                                this.applyFormatting('bold');
                                break;
                            case 'i':
                                e.preventDefault();
                                this.applyFormatting('italic');
                                break;
                            case 'k':
                                e.preventDefault();
                                this.applyFormatting('link');
                                break;
                        }
                    }
                });

                // Handle back button on mobile
                window.addEventListener('popstate', () => {
                    if (this.isMobile && this.sidebar.classList.contains('open')) {
                        this.closeMobileMenu();
                    }
                });

                // Touch events for better mobile experience
                if ('ontouchstart' in window) {
                    this.messagesContainer.addEventListener('touchstart', () => {
                        this.stopTyping();
                    });
                }
            }

            handleResize() {
                const wasMobile = this.isMobile;
                this.isMobile = window.innerWidth <= 768;
                
                if (wasMobile !== this.isMobile) {
                    if (!this.isMobile) {
                        this.closeMobileMenu();
                    }
                    this.updateMobileUI();
                }
            }

            updateMobileUI() {
                if (this.isMobile) {
                    this.mobileRoomTitle.textContent = this.currentRoomName || 'Select a room';
                } else {
                    this.closeMobileMenu();
                }
            }

            showMobileUserMenu() {
                const confirmed = confirm(`Logged in as ${this.currentUser.displayName || this.currentUser.email}. Do you want to logout?`);
                if (confirmed) {
                    this.handleLogout();
                }
            }

            initializeAuth() {
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        this.currentUser = user;
                        this.showChatScreen();
                        this.loadRooms();
                        this.updateUserPresence(true);
                    } else {
                        this.showAuthScreen();
                        if (this.currentUser) {
                            this.updateUserPresence(false);
                        }
                    }
                });

                // Handle page unload to update presence
                window.addEventListener('beforeunload', () => {
                    if (this.currentUser) {
                        this.updateUserPresence(false);
                    }
                });

                // Handle visibility change for better presence management
                document.addEventListener('visibilitychange', () => {
                    if (this.currentUser) {
                        this.updateUserPresence(!document.hidden);
                    }
                });
            }

            async updateUserPresence(isOnline) {
                if (!this.currentUser) return;
                
                try {
                    const userRef = doc(db, 'users', this.currentUser.uid);
                    await setDoc(userRef, {
                        displayName: this.currentUser.displayName || this.currentUser.email.split('@')[0],
                        email: this.currentUser.email,
                        isOnline: isOnline,
                        lastSeen: serverTimestamp()
                    }, { merge: true });

                    // Update room presence if in a room
                    if (this.currentRoom && isOnline) {
                        const roomRef = doc(db, 'rooms', this.currentRoom);
                        await updateDoc(roomRef, {
                            onlineUsers: arrayUnion(this.currentUser.uid)
                        });
                    } else if (this.currentRoom && !isOnline) {
                        const roomRef = doc(db, 'rooms', this.currentRoom);
                        await updateDoc(roomRef, {
                            onlineUsers: arrayRemove(this.currentUser.uid)
                        });
                    }
                } catch (error) {
                    console.error('Error updating presence:', error);
                }
            }

            toggleAuthMode() {
                this.isLogin = !this.isLogin;
                if (this.isLogin) {
                    this.authTitle.textContent = 'Welcome Back';
                    this.authSubmit.textContent = 'Sign In';
                    this.authSwitchText.textContent = "Don't have an account?";
                    this.authSwitchBtn.textContent = 'Sign Up';
                    this.usernameGroup.classList.add('hidden');
                } else {
                    this.authTitle.textContent = 'Create Account';
                    this.authSubmit.textContent = 'Sign Up';
                    this.authSwitchText.textContent = 'Already have an account?';
                    this.authSwitchBtn.textContent = 'Sign In';
                    this.usernameGroup.classList.remove('hidden');
                }
            }

            async handleAuth(e) {
                e.preventDefault();
                this.showLoading(true);
                this.hideMessages();

                const email = this.emailInput.value;
                const password = this.passwordInput.value;
                const username = this.usernameInput.value;

                try {
                    if (this.isLogin) {
                        await signInWithEmailAndPassword(auth, email, password);
                        this.showMessage('Successfully signed in!');
                    } else {
                        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                        if (username) {
                            await updateProfile(userCredential.user, {
                                displayName: username
                            });
                        }
                        this.showMessage('Account created successfully!');
                    }
                } catch (error) {
                    this.showMessage(this.getErrorMessage(error.code), true);
                } finally {
                    this.showLoading(false);
                }
            }

            async handleLogout() {
                try {
                    await this.updateUserPresence(false);
                    await signOut(auth);
                    this.cleanup();
                } catch (error) {
                    console.error('Logout error:', error);
                }
            }

            cleanup() {
                if (this.messagesUnsubscribe) this.messagesUnsubscribe();
                if (this.roomsUnsubscribe) this.roomsUnsubscribe();
                this.currentRoom = null;
                this.currentRoomName = '';
                this.stopTyping();
                this.closeMobileMenu();
            }

            showAuthScreen() {
                this.authScreen.style.display = 'flex';
                this.chatScreen.style.display = 'none';
            }

            showChatScreen() {
                this.authScreen.style.display = 'none';
                this.chatScreen.style.display = 'block';
                
                const displayName = this.currentUser.displayName || this.currentUser.email.split('@')[0];
                this.currentUsername.textContent = displayName;
                this.userAvatar.textContent = displayName.charAt(0).toUpperCase();
                
                this.updateMobileUI();
            }

            toggleMobileMenu() {
                this.sidebar.classList.toggle('open');
                this.sidebarOverlay.classList.toggle('active');
                
                // Prevent body scrolling when menu is open
                if (this.sidebar.classList.contains('open')) {
                    document.body.style.overflow = 'hidden';
                    // Push state to handle back button
                    history.pushState({ mobileMenuOpen: true }, '', '');
                } else {
                    document.body.style.overflow = '';
                }
            }

            closeMobileMenu() {
                this.sidebar.classList.remove('open');
                this.sidebarOverlay.classList.remove('active');
                document.body.style.overflow = '';
            }

            async createRoom() {
                const roomName = this.newRoomInput.value.trim();
                if (!roomName) return;

                try {
                    const roomId = roomName.toLowerCase().replace(/\s+/g, '-') + '-' + Date.now();
                    const roomRef = doc(db, 'rooms', roomId);
                    await setDoc(roomRef, {
                        name: roomName,
                        emoji: '🏠',
                        createdAt: serverTimestamp(),
                        createdBy: this.currentUser.displayName || this.currentUser.email,
                        messageCount: 0,
                        onlineUsers: []
                    });
                    this.newRoomInput.value = '';
                    this.showMessage('Room created successfully!');
                } catch (error) {
                    console.error('Error creating room:', error);
                    this.showMessage('Error creating room. Please try again.', true);
                }
            }

            loadRooms() {
                const roomsQuery = query(collection(db, 'rooms'), orderBy('createdAt', 'desc'));
                this.roomsUnsubscribe = onSnapshot(roomsQuery, (snapshot) => {
                    this.roomsList.innerHTML = '';
                    snapshot.forEach((doc) => {
                        const room = doc.data();
                        this.renderRoom(doc.id, room);
                    });
                });
            }

            renderRoom(roomId, room) {
                const roomElement = document.createElement('div');
                roomElement.className = 'room-item';
                
                const onlineCount = room.onlineUsers ? room.onlineUsers.length : 0;
                
                roomElement.innerHTML = `
                    <div class="room-emoji">${room.emoji || '🏠'}</div>
                    <div class="room-info">
                        <h4>${room.name}</h4>
                        <div class="room-meta">
                            <span>${room.messageCount || 0} messages</span>
                            <div class="online-count">
                                <div class="online-dot"></div>
                                <span>${onlineCount} online</span>
                            </div>
                        </div>
                    </div>
                `;
                roomElement.addEventListener('click', () => this.joinRoom(roomId, room.name));
                this.roomsList.appendChild(roomElement);
            }

            async joinRoom(roomId, roomName) {
                // Update active room styling
                document.querySelectorAll('.room-item').forEach(item => {
                    item.classList.remove('active');
                });
                event.currentTarget.classList.add('active');

                // Leave previous room
                if (this.currentRoom) {
                    await this.leaveRoom();
                }

                this.currentRoom = roomId;
                this.currentRoomName = roomName;
                this.currentRoomNameElement.textContent = roomName;
                this.currentRoomSubtitle.textContent = `Welcome to ${roomName}!`;
                
                // Update mobile header
                if (this.isMobile) {
                    this.mobileRoomTitle.textContent = roomName;
                }
                
                this.messageInput.disabled = false;
                this.sendBtn.disabled = false;
                
                // Update room presence
                await this.updateUserPresence(true);
                
                this.loadMessages();
                this.closeMobileMenu();
            }

            async leaveRoom() {
                if (!this.currentRoom) return;
                
                try {
                    const roomRef = doc(db, 'rooms', this.currentRoom);
                    await updateDoc(roomRef, {
                        onlineUsers: arrayRemove(this.currentUser.uid)
                    });
                } catch (error) {
                    console.error('Error leaving room:', error);
                }
            }

            loadMessages() {
                if (this.messagesUnsubscribe) this.messagesUnsubscribe();
                
                const messagesQuery = query(
                    collection(db, 'rooms', this.currentRoom, 'messages'),
                    orderBy('timestamp', 'asc'),
                    limit(50)
                );

                this.messagesUnsubscribe = onSnapshot(messagesQuery, (snapshot) => {
                    this.messagesContainer.innerHTML = '';
                    snapshot.forEach((doc) => {
                        const message = doc.data();
                        this.renderMessage(message);
                    });
                    this.scrollToBottom();
                });

                // Listen for typing indicators
                this.listenForTyping();
            }

            listenForTyping() {
                const typingQuery = query(
                    collection(db, 'rooms', this.currentRoom, 'typing'),
                    where('isTyping', '==', true)
                );

                onSnapshot(typingQuery, (snapshot) => {
                    this.typingUsers.clear();
                    snapshot.forEach((doc) => {
                        const data = doc.data();
                        if (data.userId !== this.currentUser.uid) {
                            this.typingUsers.add(data.displayName);
                        }
                    });
                    this.updateTypingIndicator();
                });
            }

            updateTypingIndicator() {
                const typingArray = Array.from(this.typingUsers);
                if (typingArray.length === 0) {
                    this.typingIndicator.classList.add('hidden');
                } else {
                    let typingText = '';
                    if (typingArray.length === 1) {
                        typingText = `${typingArray[0]} is typing`;
                    } else if (typingArray.length === 2) {
                        typingText = `${typingArray[0]} and ${typingArray[1]} are typing`;
                    } else if (typingArray.length === 3) {
                        typingText = `${typingArray[0]}, ${typingArray[1]} and ${typingArray[2]} are typing`;
                    } else {
                        typingText = `${typingArray[0]}, ${typingArray[1]} and ${typingArray.length - 2} others are typing`;
                    }
                    this.typingText.textContent = typingText;
                    this.typingIndicator.classList.remove('hidden');
                }
            }

            async handleTyping() {
                if (!this.currentRoom || this.isTyping) return;

                this.isTyping = true;
                
                try {
                    const typingRef = doc(db, 'rooms', this.currentRoom, 'typing', this.currentUser.uid);
                    await setDoc(typingRef, {
                        userId: this.currentUser.uid,
                        displayName: this.currentUser.displayName || this.currentUser.email.split('@')[0],
                        isTyping: true,
                        timestamp: serverTimestamp()
                    });

                    clearTimeout(this.typingTimeout);
                    this.typingTimeout = setTimeout(() => {
                        this.stopTyping();
                    }, 3000);
                } catch (error) {
                    console.error('Error updating typing status:', error);
                }
            }

            async stopTyping() {
                if (!this.currentRoom || !this.isTyping) return;

                this.isTyping = false;
                clearTimeout(this.typingTimeout);

                try {
                    const typingRef = doc(db, 'rooms', this.currentRoom, 'typing', this.currentUser.uid);
                    await setDoc(typingRef, {
                        userId: this.currentUser.uid,
                        displayName: this.currentUser.displayName || this.currentUser.email.split('@')[0],
                        isTyping: false,
                        timestamp: serverTimestamp()
                    });
                } catch (error) {
                    console.error('Error stopping typing:', error);
                }
            }

            renderMessage(message) {
                const messageElement = document.createElement('div');
                const isOwn = message.userId === this.currentUser.uid;
                messageElement.className = `message ${isOwn ? 'own' : ''}`;
                
                const timestamp = message.timestamp?.toDate() || new Date();
                const timeStr = timestamp.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                
                messageElement.innerHTML = `
                    <div class="message-avatar">${(message.displayName || 'U').charAt(0).toUpperCase()}</div>
                    <div class="message-content">
                        <div class="message-header">
                            <span class="message-author">${message.displayName || 'Unknown User'}</span>
                            <span class="message-time">${timeStr}</span>
                        </div>
                        <div class="message-text">${this.formatMessage(message.text)}</div>
                    </div>
                `;
                this.messagesContainer.appendChild(messageElement);
            }

            formatMessage(text) {
                // Enhanced text formatting with simpler syntax
                return text
                    // Bold text (single asterisk)
                    .replace(/\*([^*]+)\*/g, '<strong>$1</strong>')
                    // Italic text (underscores)
                    .replace(/_([^_]+)_/g, '<em>$1</em>')
                    // Code blocks
                    .replace(/```([\s\S]*?)```/g, '<pre style="background: rgba(0,0,0,0.1); padding: 0.5rem; border-radius: 4px; margin: 0.5rem 0; overflow-x: auto;"><code>$1</code></pre>')
                    // Inline code
                    .replace(/`([^`]+)`/g, '<code style="background: rgba(0,0,0,0.1); padding: 0.2rem 0.4rem; border-radius: 3px; font-family: monospace;">$1</code>')
                    // Links with proper parsing - fixed to extract URL correctly
                    .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" rel="noopener" style="text-decoration: underline;">$1</a>')
                    // Line breaks
                    .replace(/\n/g, '<br>');
            }

            updateFormatPreview() {
                const text = this.messageInput.value;
                if (text.trim()) {
                    this.formatPreview.innerHTML = this.formatMessage(text);
                } else {
                    this.formatPreview.textContent = 'Start typing to see formatting preview...';
                }
            }

            async sendMessage() {
                const text = this.messageInput.value.trim();
                if (!text || !this.currentRoom) return;

                try {
                    await this.stopTyping();
                    
                    await addDoc(collection(db, 'rooms', this.currentRoom, 'messages'), {
                        text: text,
                        userId: this.currentUser.uid,
                        displayName: this.currentUser.displayName || this.currentUser.email.split('@')[0],
                        timestamp: serverTimestamp()
                    });

                    // Update message count in room
                    const roomRef = doc(db, 'rooms', this.currentRoom);
                    const currentCount = await this.getRoomMessageCount();
                    await updateDoc(roomRef, { messageCount: currentCount + 1 });

                    this.messageInput.value = '';
                    this.formatPreview.textContent = 'Start typing to see formatting preview...';
                    this.resizeTextarea();
                } catch (error) {
                    console.error('Error sending message:', error);
                    this.showMessage('Error sending message. Please try again.', true);
                }
            }

            async getRoomMessageCount() {
                try {
                    const messagesQuery = query(collection(db, 'rooms', this.currentRoom, 'messages'));
                    const snapshot = await getDocs(messagesQuery);
                    return snapshot.size;
                } catch (error) {
                    console.error('Error getting message count:', error);
                    return 0;
                }
            }

            initializeFormatting() {
                const formatBtns = document.querySelectorAll('.format-btn');
                formatBtns.forEach(btn => {
                    btn.addEventListener('click', () => {
                        const format = btn.dataset.format;
                        this.applyFormatting(format);
                    });
                });
            }

            applyFormatting(format) {
                const start = this.messageInput.selectionStart;
                const end = this.messageInput.selectionEnd;
                const selectedText = this.messageInput.value.substring(start, end);
                let formattedText = '';
                let newCursorPos = start;

                switch (format) {
                    case 'bold':
                        if (selectedText) {
                            formattedText = `*${selectedText}*`;
                            newCursorPos = start + formattedText.length;
                        } else {
                            formattedText = '*bold text*';
                            newCursorPos = start + 1;
                        }
                        break;
                    case 'italic':
                        if (selectedText) {
                            formattedText = `_${selectedText}_`;
                            newCursorPos = start + formattedText.length;
                        } else {
                            formattedText = '_italic text_';
                            newCursorPos = start + 1;
                        }
                        break;
                    case 'code':
                        if (selectedText) {
                            formattedText = `\`${selectedText}\``;
                            newCursorPos = start + formattedText.length;
                        } else {
                            formattedText = '`code`';
                            newCursorPos = start + 1;
                        }
                        break;
                    case 'link':
                        const linkUrl = prompt('Enter the URL:', 'https://');
                        if (linkUrl && linkUrl !== 'https://') {
                            if (selectedText) {
                                formattedText = `[${selectedText}](${linkUrl})`;
                                newCursorPos = start + formattedText.length;
                            } else {
                                const linkText = prompt('Enter the link text:', 'link text');
                                if (linkText) {
                                    formattedText = `[${linkText}](${linkUrl})`;
                                    newCursorPos = start + formattedText.length;
                                } else {
                                    return; // User cancelled
                                }
                            }
                        } else {
                            return; // User cancelled or entered invalid URL
                        }
                        break;
                }

                const beforeText = this.messageInput.value.substring(0, start);
                const afterText = this.messageInput.value.substring(end);
                
                this.messageInput.value = beforeText + formattedText + afterText;
                this.messageInput.focus();
                
                // Set cursor position for better user experience
                if (format === 'bold' && !selectedText) {
                    this.messageInput.setSelectionRange(start + 1, start + 10);
                } else if (format === 'italic' && !selectedText) {
                    this.messageInput.setSelectionRange(start + 1, start + 12);
                } else if (format === 'code' && !selectedText) {
                    this.messageInput.setSelectionRange(start + 1, start + 5);
                } else {
                    this.messageInput.setSelectionRange(newCursorPos, newCursorPos);
                }

                this.updateFormatPreview();
            }

            scrollToBottom() {
                this.messagesContainer.scrollTop = this.messagesContainer.scrollHeight;
            }

            resizeTextarea() {
                this.messageInput.style.height = 'auto';
                this.messageInput.style.height = Math.min(this.messageInput.scrollHeight, 120) + 'px';
            }

            showLoading(show) {
                if (show) {
                    this.loading.classList.remove('hidden');
                    this.authSubmit.disabled = true;
                } else {
                    this.loading.classList.add('hidden');
                    this.authSubmit.disabled = false;
                }
            }

            showMessage(message, isError = false) {
                this.hideMessages();
                const element = isError ? this.errorMessage : this.successMessage;
                element.textContent = message;
                element.classList.remove('hidden');
                
                setTimeout(() => {
                    element.classList.add('hidden');
                }, 5000);
            }

            hideMessages() {
                this.errorMessage.classList.add('hidden');
                this.successMessage.classList.add('hidden');
            }

            getErrorMessage(errorCode) {
                const errorMessages = {
                    'auth/user-not-found': 'No account found with this email.',
                    'auth/wrong-password': 'Incorrect password.',
                    'auth/email-already-in-use': 'An account with this email already exists.',
                    'auth/weak-password': 'Password should be at least 6 characters.',
                    'auth/invalid-email': 'Please enter a valid email address.',
                    'auth/too-many-requests': 'Too many failed attempts. Please try again later.',
                    'auth/network-request-failed': 'Network error. Please check your connection.',
                    'auth/invalid-credential': 'Invalid email or password.',
                };
                return errorMessages[errorCode] || 'An error occurred. Please try again.';
            }
        }

        // Initialize the app
        window.addEventListener('DOMContentLoaded', () => {
            const app = new ChatterBoxApp();
            window.chatterBoxApp = app; // Make it globally accessible
        });

        // Auto-resize textarea
        document.addEventListener('input', function(e) {
            if (e.target.id === 'messageInput') {
                e.target.style.height = 'auto';
                e.target.style.height = Math.min(e.target.scrollHeight, 120) + 'px';
            }
        });

        // Add some default rooms on first load
        window.createDefaultRooms = async function() {
            const defaultRooms = [
                { name: 'General', emoji: '💬' },
                { name: 'Random', emoji: '🎲' },
                { name: 'Tech Talk', emoji: '💻' },
                { name: 'Gaming', emoji: '🎮' },
                { name: 'Music', emoji: '🎵' },
                { name: 'Movies', emoji: '🎬' }
            ];

            for (const room of defaultRooms) {
                const roomId = room.name.toLowerCase().replace(/\s+/g, '-');
                const roomRef = doc(db, 'rooms', roomId);
                try {
                    await setDoc(roomRef, {
                        name: room.name,
                        emoji: room.emoji,
                        createdAt: serverTimestamp(),
                        createdBy: 'System',
                        messageCount: 0,
                        onlineUsers: []
                    });
                } catch (error) {
                    console.log('Room might already exist:', room.name);
                }
            }
        };

        // Create default rooms on first visit
        setTimeout(() => {
            if (auth.currentUser) {
                window.createDefaultRooms();
            }
        }, 2000);

        // Progressive Web App support
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then((registration) => {
                        console.log('SW registered: ', registration);
                    })
                    .catch((registrationError) => {
                        console.log('SW registration failed: ', registrationError);
                    });
            });
        }

        // Handle online/offline status
        window.addEventListener('online', () => {
            if (window.chatterBoxApp && window.chatterBoxApp.currentUser) {
                window.chatterBoxApp.updateUserPresence(true);
            }
        });

        window.addEventListener('offline', () => {
            if (window.chatterBoxApp && window.chatterBoxApp.currentUser) {
                window.chatterBoxApp.updateUserPresence(false);
            }
        });

        // Prevent zoom on double tap for better mobile experience
        let lastTouchEnd = 0;
        document.addEventListener('touchend', function (event) {
            const now = (new Date()).getTime();
            if (now - lastTouchEnd <= 300) {
                event.preventDefault();
            }
            lastTouchEnd = now;
        }, false);

        // Handle keyboard visibility on mobile
        if (/Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
            const viewport = document.querySelector('meta[name="viewport"]');
            
            window.addEventListener('resize', () => {
                if (document.activeElement.tagName === 'INPUT' || document.activeElement.tagName === 'TEXTAREA') {
                    viewport.content = 'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0';
                } else {
                    viewport.content = 'width=device-width, initial-scale=1.0';
                }
            });
        }

        // Add touch feedback for better mobile interaction
        document.addEventListener('touchstart', function(e) {
            if (e.target.classList.contains('room-item') || 
                e.target.classList.contains('format-btn') || 
                e.target.classList.contains('auth-btn') ||
                e.target.classList.contains('send-btn') ||
                e.target.classList.contains('create-room-btn')) {
                e.target.style.transform = 'scale(0.95)';
                e.target.style.opacity = '0.8';
            }
        });

        document.addEventListener('touchend', function(e) {
            if (e.target.classList.contains('room-item') || 
                e.target.classList.contains('format-btn') || 
                e.target.classList.contains('auth-btn') ||
                e.target.classList.contains('send-btn') ||
                e.target.classList.contains('create-room-btn')) {
                setTimeout(() => {
                    e.target.style.transform = '';
                    e.target.style.opacity = '';
                }, 150);
            }
        });

        // Handle focus/blur for better mobile keyboard experience
        const messageInput = document.getElementById('messageInput');
        if (messageInput) {
            messageInput.addEventListener('focus', () => {
                if (window.innerWidth <= 768) {
                    setTimeout(() => {
                        messageInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }, 300);
                }
            });
        }

        // Add connection status indicator
        let connectionStatus = 'online';
        function updateConnectionStatus(status) {
            connectionStatus = status;
            const indicator = document.createElement('div');
            indicator.className = 'connection-status';
            indicator.textContent = status === 'online' ? '🟢 Connected' : '🔴 Disconnected';
            indicator.style.cssText = `
                position: fixed;
                top: 10px;
                right: 10px;
                background: ${status === 'online' ? '#48bb78' : '#e53e3e'};
                color: white;
                padding: 0.5rem 1rem;
                border-radius: 20px;
                font-size: 0.8rem;
                z-index: 10000;
                transition: all 0.3s ease;
            `;
            
            document.body.appendChild(indicator);
            setTimeout(() => {
                if (indicator.parentNode) {
                    indicator.remove();
                }
            }, 3000);
        }

        window.addEventListener('online', () => updateConnectionStatus('online'));
        window.addEventListener('offline', () => updateConnectionStatus('offline'));

        // Add notification support (if permissions granted)
        function requestNotificationPermission() {
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission();
            }
        }

        // Request notification permission after user interaction
        document.addEventListener('click', requestNotificationPermission, { once: true });

        // Add PWA install prompt
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            // Show custom install button
            const installBtn = document.createElement('button');
            installBtn.textContent = '📱 Install App';
            installBtn.style.cssText = `
                position: fixed;
                bottom: 20px;
                left: 20px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                border: none;
                padding: 0.75rem 1.5rem;
                border-radius: 25px;
                cursor: pointer;
                z-index: 1000;
                font-weight: 600;
                box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
                transition: all 0.2s;
            `;
            
            installBtn.addEventListener('click', async () => {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    const { outcome } = await deferredPrompt.userChoice;
                    console.log(`User response to install prompt: ${outcome}`);
                    deferredPrompt = null;
                    installBtn.remove();
                }
            });
            
            installBtn.addEventListener('mouseenter', () => {
                installBtn.style.transform = 'translateY(-2px)';
                installBtn.style.boxShadow = '0 6px 16px rgba(102, 126, 234, 0.4)';
            });
            
            installBtn.addEventListener('mouseleave', () => {
                installBtn.style.transform = '';
                installBtn.style.boxShadow = '0 4px 12px rgba(102, 126, 234, 0.3)';
            });
            
            document.body.appendChild(installBtn);
            
            // Hide after 10 seconds
            setTimeout(() => {
                if (installBtn.parentNode) {
                    installBtn.remove();
                }
            }, 10000);
        });

        // Add error boundary for better error handling
        window.addEventListener('error', (e) => {
            console.error('Global error:', e.error);
            
            // Show user-friendly error message
            const errorDiv = document.createElement('div');
            errorDiv.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: #fed7d7;
                color: #e53e3e;
                padding: 1rem 2rem;
                border-radius: 10px;
                border: 1px solid #feb2b2;
                z-index: 10000;
                max-width: 90%;
                text-align: center;
            `;
            errorDiv.textContent = 'Something went wrong. Please refresh the page.';
            
            document.body.appendChild(errorDiv);
            setTimeout(() => {
                if (errorDiv.parentNode) {
                    errorDiv.remove();
                }
            }, 5000);
        });

        // Add unhandled promise rejection handler
        window.addEventListener('unhandledrejection', (e) => {
            console.error('Unhandled promise rejection:', e.reason);
            e.preventDefault();
        });

        console.log('ChatterBox app initialized successfully! 🚀');

    </script>
</body>
</html>